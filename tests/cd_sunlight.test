<?php
// $Id$

/**
 * @file
 * Simpletests for the cd_sunlight module.
 */

class cdSunlightWebTestCase extends DrupalWebTestCase {

  /**
   * Implementation of getInfo() for information
   */
  public static function getInfo() {
    return array(
      'name' => t('CiviCRM Sunlight Congressional Districts tests'),
      'description' => t('Test queuing, dequeing, and data fetching.'),
      'group' => 'CiviCRM Sunlight Congressional Districts',
    );
  }

  /**
   * SimpleTest core method: code run before each and every test method.
   */
  function setUp() {

    // Install our modules.
    $args = func_get_args();
    $modules = array_merge(array('cd_sunlight', 'civicrm'), $args);
    call_user_func_array(array('parent', 'setUp'), $modules);

    // Turn CiviCRM geocoding off so that this doesn't fire when we process the queue.
    variable_set('cd_sunlight_geocoding_off', TRUE);
    _cd_sunlight_geocode_set();

    // Copy the other required variables.  Don't prefix so that we opperate on the original table.
    $cd_sunlight_api_key = unserialize(db_result(db_query(
      'SELECT value FROM variable WHERE name = "cd_sunlight_api_key"')));
    $this->verbose('API KEY:'. $cd_sunlight_api_key);
    variable_set('cd_sunlight_api_key', $cd_sunlight_api_key);
    $cd_sunlight_civicrm_cd = unserialize(db_result(db_query(
      'SELECT value FROM variable WHERE name = "cd_sunlight_civicrm_cd"')));
    variable_set('cd_sunlight_civicrm_cd', $cd_sunlight_civicrm_cd);
    $cd_sunlight_civicrm_cd_override = unserialize(db_result(db_query(
      'SELECT value FROM variable WHERE name = "cd_sunlight_civicrm_cd_override"')));
    variable_set('cd_sunlight_civicrm_cd_override', $cd_sunlight_civicrm_cd_override);

  }

  /**
   * SimpleTest core method: code run after each and every test method.
   */
  function tearDown() {
    variable_del('cd_sunlight_geocoding_off');
    variable_del('cd_sunlight_api_key');
    variable_del('cd_sunlight_civicrm_cd');
    variable_del('cd_sunlight_civicrm_cd_override');

    // Finally...
    parent::tearDown();
  }

  /**
   * Create new contact, it should be queued for lookup.
   * Dequeue and test.
   * Edit the contact, it should be queued for lookup.
   * Process the queue, it should have the correct CD retrieved.
   */
  function testCDSunlight() {

    // Setup CiviCRM
    if (!function_exists('civicrm_initialize') || !civicrm_initialize()) {
      $this->fail('CiviCRM does not appear to be setup correctly.');
      return;
    }
    $include_result = include('api/v2/Contact.php');
    if ($include_result === FALSE) {
      $this->fail('The CiviCRM Contact API could not be included.');
      return;
    }

    // Create the contact.
    $contact_modified_parameters = array(
      'first_name' => 'Simpletest test',
      'last_name' => 'Simpletest test',
      'email' => 'simpletest@example.org',
      'contact_type' => 'Individual',
      'dupe_check' => FALSE,
      'address' => array(
        '1' => array(
          'location_type_id' => 1,
          'is_primary' => TRUE,
          'postal_code' => '00501',
          'country_id' => CD_SUNLIGHT_CIVICRM_US_COUNTRY_ID,
        ),
      ),
    );
    $contact = civicrm_contact_add($contact_modified_parameters);
    if (civicrm_error($contact)) {
      $this->fail('A CiviCRM contact could not be created.  This might happen if you '.
        'have non-standard required fields or other restrictions on contacts.'.
        $this->_var_export($contact_modified_parameters, TRUE) . $this->_var_export($contact, TRUE));
      return;
    }

    // Test that it was created correctly.
    $contact_search = array(
      'contact_id' => $contact['contact_id'],
      'return.'. CD_SUNLIGHT_CIVICRM_CD => TRUE,
      'return.postal_code' => TRUE,
      'return.country' => TRUE,
      'return.contact_type' => TRUE,
    );
    $contact = _cd_sunlight_civicrm_contact_get($contact_search);
    $this->assertEqual($contact['postal_code'], '00501', 'A CiviCRM contact simpletest@example.org was created.');
    $this->verbose(
      '$contact_parameters: '. $this->_var_export($contact_modified_parameters, TRUE) .
      '$contact: '. $this->_var_export($contact, TRUE) //.
    );

    // Test that it was enqueued.
    $this->assertTrue($this->_checkQueue($contact['contact_id']), 'Contact enqueued when created.');

    // Process and test.
    variable_set('cd_sunlight_geocoding_off', FALSE);
    _cd_sunlight_process_queue();
    variable_set('cd_sunlight_geocoding_off', TRUE);
    $this->assertFalse($this->_checkQueue($contact['contact_id']), 'Contact dequeued when queue processed.');
    $contact = _cd_sunlight_civicrm_contact_get($contact_search);
    $this->assertEqual($contact[CD_SUNLIGHT_CIVICRM_CD], 'NY1', 'Contact CD is '. $contact[CD_SUNLIGHT_CIVICRM_CD]);
    $this->verbose($this->_var_export($contact_search, TRUE) . $this->_var_export($contact, TRUE));

    // Edit the contact.
    $contact_modified_parameters = array(
      'contact_id' => $contact['contact_id'],
      'contact_type' => 'Individual',
      'address' => array(
        1 => array(
          'location_type_id' => 1,
          'is_primary' => TRUE,
          'postal_code' => '12345',
        ),
      ),
    );
    $contact_modified = civicrm_contact_add($contact_modified_parameters);
    if (civicrm_error($contact)) {
      $this->fail('The CiviCRM contact could not be edited: '.
        $this->_var_export($contact_modified_parameters, TRUE) .
        $this->_var_export($contact_modified, TRUE));
      return;
    }

    // We should have the new postal code.
    $contact = _cd_sunlight_civicrm_contact_get($contact_search);
    $this->assertEqual($contact['postal_code'], '12345', 'CiviCRM contact simpletest@example.org was edited.');
    $this->verbose(
      '$contact_search: '. $this->_var_export($contact_search, TRUE) .
      '$contact: '. $this->_var_export($contact, TRUE) .
      '$contact_modified_parameters: '. $this->_var_export($contact_modified_parameters, TRUE) .
      '$contact_modified: '. $this->_var_export($contact_modified, TRUE));

    // Editing the postal code should re-enqueue the contact.
    $this->assertTrue($this->_checkQueue($contact['contact_id']), 'Contact enqueued when edited');

    // Process the queue, our contact should be processed.
    variable_set('cd_sunlight_geocoding_off', FALSE);
    _cd_sunlight_process_queue();
    variable_set('cd_sunlight_geocoding_off', TRUE);
    $this->assertFalse($this->_checkQueue($contact['contact_id']), 'Contact dequeued when queue processed.');
    $contact = _cd_sunlight_civicrm_contact_get($contact_search);
    $this->assertEqual($contact[CD_SUNLIGHT_CIVICRM_CD], 'NY21', 'Contact CD is '. $contact[CD_SUNLIGHT_CIVICRM_CD]);
    $this->verbose(
      '$contact_search: '. $this->_var_export($contact_search, TRUE) .
      '$contact: '. $this->_var_export($contact, TRUE));

    // Give the contact a bogus Zip code.
    $contact_modified_parameters = array(
      'contact_id' => $contact['contact_id'],
      'contact_type' => 'Individual',
      'address' => array(
        1 => array(
          'location_type_id' => 1,
          'is_primary' => TRUE,
          'postal_code' => '00000',
        ),
      ),
    );
    $contact_modified = civicrm_contact_add($contact_modified_parameters);
    if (civicrm_error($contact)) {
      $this->fail('The CiviCRM contact could not be edited: '.
        $this->_var_export($contact_modified_parameters, TRUE) .
        $this->_var_export($contact_modified, TRUE));
      return;
    }

    // We should have the new postal code.
    $contact = _cd_sunlight_civicrm_contact_get($contact_search);
    $this->assertEqual($contact['postal_code'], '00000', 'CiviCRM contact simpletest@example.org was edited.');
    $this->verbose(
      '$contact_search: '. $this->_var_export($contact_search, TRUE) .
      '$contact: '. $this->_var_export($contact, TRUE) .
      '$contact_modified_parameters: '. $this->_var_export($contact_modified_parameters, TRUE) .
      '$contact_modified: '. $this->_var_export($contact_modified, TRUE));

    // Editing the postal code should re-enqueue the contact.
    $this->assertTrue($this->_checkQueue($contact['contact_id']), 'Contact enqueued when edited');

    // Process the queue, our contact should be processed.
    variable_set('cd_sunlight_geocoding_off', FALSE);
    _cd_sunlight_process_queue();
    variable_set('cd_sunlight_geocoding_off', TRUE);
    $this->assertFalse($this->_checkQueue($contact['contact_id']), 'Contact dequeued when queue processed.');
    $contact = _cd_sunlight_civicrm_contact_get($contact_search);
    // The old CD should remain in place.
    $this->assertEqual($contact[CD_SUNLIGHT_CIVICRM_CD], 'NY21', 'Contact CD is '. $contact[CD_SUNLIGHT_CIVICRM_CD]);
    $this->verbose(
      '$contact_search: '. $this->_var_export($contact_search, TRUE) .
      '$contact: '. $this->_var_export($contact, TRUE));

    // Give the contact a bogus Zip code and remove the old CD.
    $contact_modified_parameters = array(
      'contact_id' => $contact['contact_id'],
      'contact_type' => 'Individual',
      CD_SUNLIGHT_CIVICRM_CD => '',
      'address' => array(
        1 => array(
          'location_type_id' => 1,
          'is_primary' => TRUE,
          'postal_code' => '00001',
        ),
      ),
    );
    $contact_modified = civicrm_contact_add($contact_modified_parameters);
    if (civicrm_error($contact)) {
      $this->fail('The CiviCRM contact could not be edited: '.
        $this->_var_export($contact_modified_parameters, TRUE) .
        $this->_var_export($contact_modified, TRUE));
      return;
    }

    // We should have the new postal code and the CD should be gone.
    $contact = _cd_sunlight_civicrm_contact_get($contact_search);
    $this->assertEqual($contact['postal_code'], '00001', 'CiviCRM contact simpletest@example.org was edited.');
    $this->assertEqual($contact[CD_SUNLIGHT_CIVICRM_CD], '', 'CiviCRM contact simpletest@example.org CD was removed.');
    $this->verbose(
      '$contact_search: '. $this->_var_export($contact_search, TRUE) .
      '$contact: '. $this->_var_export($contact, TRUE) .
      '$contact_modified_parameters: '. $this->_var_export($contact_modified_parameters, TRUE) .
      '$contact_modified: '. $this->_var_export($contact_modified, TRUE));

    // Editing the postal code should re-enqueue the contact.
    $this->assertTrue($this->_checkQueue($contact['contact_id']), 'Contact enqueued when edited');

    // Process the queue, our contact should be processed.
    variable_set('cd_sunlight_geocoding_off', FALSE);
    _cd_sunlight_process_queue();
    variable_set('cd_sunlight_geocoding_off', TRUE);
    $this->assertFalse($this->_checkQueue($contact['contact_id']), 'Contact dequeued when queue processed.');
    $contact = _cd_sunlight_civicrm_contact_get($contact_search);
    // The old CD should remain in place.
    $this->assertEqual($contact[CD_SUNLIGHT_CIVICRM_CD], 'not found', 'Contact CD is '. $contact[CD_SUNLIGHT_CIVICRM_CD]);
    $this->verbose(
      '$contact_search: '. $this->_var_export($contact_search, TRUE) .
      '$contact: '. $this->_var_export($contact, TRUE));

    // Cleanup. Delete the contact.
    $result = civicrm_contact_delete($contact);
    if ($result['is_error']) {
      $this->fail("The test CiviCRM contact 'Simpletest test' could not be deleted.");
    }

  }

  /**
   * Is the contact ID in the cron queue?
   *
   * @param int $contact_id
   */
  private function _checkQueue($contact_id) {
    return db_result(db_query(
      'SELECT 1 FROM {cd_sunlight_cron} WHERE contact_id = %d AND processed = 0', $contact_id));
  }

  /**
   * Print out a variable for HTML display.
   *
   * @param mixed $variable
   * @return string
   */
  private function _var_export($variable) {
    return nl2br(var_export($variable, TRUE));
  }

}